define("common/comment-section/index",function(require,exports,module){function init(t){t=t||{},productId=t.id||Util.getParam("g"),productName=t.name||$(".item-title").text(),addEvent(),initPageLoader(),initSupport()}function addEvent(){$("#J-support-btn").on("click",support),$discussList.on("click",".img-list > li",previewImg),$discussList.on("click",".yes-bar",discussSupport),$("#J-layer-btn").on("click",showLayer),$(document.body).on("click",function(){$("#J-layer-btn").parent().removeClass("show")})}function showLayer(t){t.stopPropagation();var n=$(this).parent();n.hasClass("show")?n.removeClass("show"):n.addClass("show")}function initPageLoader(){var ajaxUrl=$("#J-ajaxurl-moreComment").val();ajaxUrl&&new PageLoader({container:"#J-discuss-list",seeMore:".see-more",getHtml:function(pageNum,back){(new Ajax).send({url:ajaxUrl,data:{g:productId,page:pageNum}},function(result){var list=result.commentlist.data;0==list.length&&1==pageNum&&$("#J-discuss-list").parent().addClass("empty"),1==pageNum&&($("#J-discuss-amount").text(result.commentlist.total_num),resetLayer({canComment:result.commentlist.canComment,link:result.commentlist.commentUrl})),back&&back(function(obj){{var __t,__p="";Array.prototype.join}with(obj||{})__p+="",$.each(list,function(t,n){__p+='\r\n<li>\r\n	<div class="img-wrap" style="background-image:url('+(null==(__t=n.head_sculpture)?"":__t)+')"></div>\r\n	<div class="info">\r\n		<div class="name-wrap">\r\n			<label class="name">'+(null==(__t=n.customer_name)?"":__t)+'</label>\r\n			<span item-id="'+(null==(__t=n.id)?"":__t)+'" class="yes-bar '+(null==(__t=n.isSupport?"active":"")?"":__t)+'"><i class="icon-yes"></i><b>'+(null==(__t=n.comment_praise_num)?"":__t)+'</b></span>\r\n		</div>\r\n		<div class="star-wrap">\r\n			<div class="star-bar">\r\n				<div class="star-gray"></div>\r\n				<div class="star-inner" style="width:'+(null==(__t=n.product_score/5*100)?"":__t)+'%;">\r\n					<div class="star-active"></div>\r\n				</div>\r\n			</div>\r\n			<span class="date">'+(null==(__t=n.create_time)?"":__t)+'</span>\r\n		</div>\r\n		<p class="cotent">'+(null==(__t=n.comment_content)?"":__t)+"</p>\r\n		",n.imgList&&n.imgList.length>0&&(__p+='\r\n		<ul class="img-list">\r\n			',$.each(n.imgList,function(t,n){__p+='\r\n			<li style="background-image:url('+(null==(__t=n)?"":__t)+')"></li>\r\n			'}),__p+="\r\n		</ul>\r\n		"),__p+="\r\n		",$.each(n.reply,function(t,e){__p+='\r\n		<p class="cotent-replay"><b>'+(null==(__t=e.reply_user)?"":__t)+"</b>回复<b>"+(null==(__t=n.customer_name)?"":__t)+"</b>："+(null==(__t=e.back_content)?"":__t)+"</p>\r\n		"}),__p+="\r\n	</div>\r\n</li>\r\n"}),__p+="";return __p}({list:list}),result.commentlist.total_num)})}}).loadFirst().loadEnd(function(){$(".see-more").remove()})}function resetLayer(t){var n=$("#J-discuss-layer");1==t.canComment&&(n.find(".J-comment").attr("href",t.link),n.css("display","block"))}function initSupport(){var ajaxUrl=$("#J-ajaxurl-initProductLikeData").val();ajaxUrl&&(new Ajax).send({url:ajaxUrl,data:{g:productId}},function(result){var $btn=$("#J-support-btn"),$supportList=$(".support-list");isInitSupport=!0,result.isSupport&&$btn.addClass("active"),$btn.find(".J-num").text(result.supportTotal),$supportList.html(function(obj){{var __t,__p="";Array.prototype.join}with(obj||{})__p+="",$.each(list,function(t,n){__p+='\r\n<li style="background-image:url('+(null==(__t=n.headImg)?"":__t)+')"></li>\r\n'}),__p+="";return __p}({list:result.supportList})),result.supportList.length>0&&$supportList.css("display","block")})}function support(){var t=$(this),n=t.find(".J-num");return isInitSupport?t.hasClass("active")?void Bubble.show("您已赞过，不能重复点赞"):(t.addClass("active"),n.text(parseInt(n.text(),10)+1),void(new Ajax).send(Ajax.formatAjaxParams(t),function(t){t.headImg&&$(".support-list").prepend('<li style="background-image:url('+t.headImg+')"></li>').css("display","block")})):!1}function discussSupport(){var t=$(this),n=t.find("b");t.hasClass("active")||(t.addClass("active"),n.text(+n.text()+1),(new Ajax).send({url:"/Mall/Goods/setCommentLike",data:{id:t.attr("item-id")}},function(){}))}function previewImg(){var t=$(this),n=[],e=0;t.parent().children().each(function(s,i){t[0]==i&&(e=s),n.push($(i).css("background-image").match(/url\((.*)\)/)[1])}),Preview.show(n,e)}var productId,productName,$=require("zepto"),Ajax=require("common/ajax/index"),Preview=require("common/preview/index"),PageLoader=require("common/page-loader/index"),Util=require("common/util/index"),Bubble=require("common/bubble/bubble"),isInitSupport=!1,$discussList=$("#J-discuss-list");module.exports={init:init}});